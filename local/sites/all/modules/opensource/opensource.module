<?php

/**
 * Implementation of hook_form_alter
 */
function opensource_form_alter(&$form, &$form_state, $form_id) {
 // If we have a lead image, we know we should include an /imce upload link
 if($form['field_lead_image']) {
  $form['imce_link'] = array(
    '#type' => 'markup',
    '#weight' => -10,
    '#value' => l("Upload Images", "imce", array('attributes' => array('target' => '_blank'))),
  );
 }
}

/**
 * Implementation of hook_block
 */
function opensource_block($op = 'list', $delta = 0, $edit = array()) {
  switch($op) {
    case "list":
      $blocks = array();
      $blocks['foobar'] = array('info' => 'Dummy Block');
      $blocks['opensource-social-links'] = array(
        'info' => 'opensource: Social Links',
      );
      return $blocks;
    case "view":
      if($delta == 'opensource-social-links'){
        $block = array(
          'subject' => '<none>',
          'content' => opensource_display_social_block(),
        );
      }
      return $block;
  }
}

function opensource_display_social_block() {
  $links = array();
  $links['twitter'] = array(
    'href' => 'http://twitter.com/opensourceway',
    'title' => theme_image('sites/all/themes/sitetheme/images/twitter.jpg'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  $links['facebook'] = array(
    'href' => 'http://facebook.com/pages/opensourcecom/162962298056',
    'title' => theme_image('sites/all/themes/sitetheme/images/facebook.jpg'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  $links['identica'] = array(
    'href' => 'http://identi.ca/opensourceway',
    'title' => theme_image('sites/all/themes/sitetheme/images/identica.png'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  $links['flickr'] = array(
    'href' => 'http://www.flickr.com/photos/opensourceway',
    'title' => theme_image('sites/all/themes/sitetheme/images/flickr_24x24.jpg'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  $links['youtube'] = array(
    'href' => 'http://www.youtube.com/opensourceway',
    'title' => theme_image('sites/all/themes/sitetheme/images/youtube.jpg'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  $links['rss'] = array(
    'href' => 'http://opensource.com/feed',
    'title' => theme_image('sites/all/themes/sitetheme/images/osdc_rss_24x24.png'),
    'attributes' => array('target' => '_blank'),
    'html' => TRUE,
  );
  
  $output = theme_links($links, array('class' => 'social-links'));
  $output .= l(theme_image('sites/all/themes/sitetheme/images/email-signup.png'), 'https://engage.redhat.com/forms/opensourcedotcom-subscription',
               array('html' => TRUE, 'attributes' => array('class' => 'newsletter', 'target' => '_blank')));
  // @TODO: Reimplement this when the eloqua folks respond.
  $output .= drupal_get_form('opensource_eloqua_form');
  return $output;
}

function opensource_init(){
  if(array_key_exists('success', $_REQUEST)) {
    drupal_set_message('Thank you. You have been subscribed to our weekly email.');
  }
}

function opensource_eloqua_form(){
  // Build the Redirect
  $redirect = url($_GET['q'], array('absolute' => TRUE, 'query' => 'success'));
  
  $form['C_EmailAddress'] = array(
    '#type' => 'textfield',
    '#default_value' => $object['foo'],
    '#size' => 24,
    '#maxlength' => 96,
  );
  $form['elqFormName'] = array(
    '#type' => 'hidden',
    '#value' => 'opensourcedotcom-subscription',
  );
  
  $form['elqSiteID'] = array(
    '#type' => 'hidden',
    '#value' => 1795,
  );
  
  $form['sendToURL'] = array(
    '#type' => 'hidden',
    '#value' => check_url($redirect),
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Sign Up'),
  );
  $form['#action'] = 'https://secure.eloqua.com/e/f2.aspx';
  $form['#id'] = 'opensourcedotcom-subscription';
  $form['#redirect'] = base_path();
  
  return $form;
}

function opensource_eloqua_form_validate($form, &$form_state) {
  if ($form_state['values']['c_EmailAddress'] == '') {    
    form_set_error('name', t('You must enter a valid email address.'));
  }
}